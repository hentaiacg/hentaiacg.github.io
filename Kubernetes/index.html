<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Kubernetes 安装 | Rishinyan</title><meta name="author" content="Rishinyan,shinyanri@gmail.com"><meta name="copyright" content="Rishinyan"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="k8s 安装">
<meta property="og:type" content="article">
<meta property="og:title" content="Kubernetes 安装">
<meta property="og:url" content="https://blog.rishinyan.top/Kubernetes/">
<meta property="og:site_name" content="Rishinyan">
<meta property="og:description" content="k8s 安装">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://ff09945.webp.li/MorishimaHaruka_3.png">
<meta property="article:published_time" content="2023-11-10T16:00:00.000Z">
<meta property="article:modified_time" content="2025-03-14T07:58:06.653Z">
<meta property="article:author" content="Rishinyan">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://ff09945.webp.li/MorishimaHaruka_3.png"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Kubernetes 安装",
  "url": "https://blog.rishinyan.top/Kubernetes/",
  "image": "https://ff09945.webp.li/MorishimaHaruka_3.png",
  "datePublished": "2023-11-10T16:00:00.000Z",
  "dateModified": "2025-03-14T07:58:06.653Z",
  "author": [
    {
      "@type": "Person",
      "name": "Rishinyan",
      "url": "https://blog.rishinyan.top/"
    }
  ]
}</script><link rel="shortcut icon" href="https://ff09945.webp.li/watch_neko.jpg"><link rel="canonical" href="https://blog.rishinyan.top/Kubernetes/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//static.cloudflareinsights.com"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script defer="defer" data-pjax="data-pjax" src="https://static.cloudflareinsights.com/beacon.min.js" data-cf-beacon="{&quot;token&quot;: &quot;50a7ba8f0875473cb18b83fd39f34467&quot;}"></script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":200,"highlightFullpage":false,"highlightMacStyle":true},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":150,"languages":{"author":"作者: Rishinyan","link":"链接: ","source":"来源: Rishinyan","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'medium_zoom',
  Snackbar: {"chs_to_cht":"已切换为繁体中文","cht_to_chs":"已切换为简体中文","day_to_night":"已切换为深色模式","night_to_day":"已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#1f1f1f","position":"bottom-left"},
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: true,
  islazyloadPlugin: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Kubernetes 安装',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><link rel="stylesheet" href="/css/wave.css"><link rel="stylesheet" href="/css/mouse.css"><link rel="stylesheet" href="/css/progress_bar.css"><meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/atom.xml" title="Rishinyan" type="application/atom+xml">
</head><body><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><div class="loading-img"></div><div class="loading-image-dot"></div></div></div><script>const preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',()=> { preloader.endLoading() })

if (false) {
  document.addEventListener('pjax:send', () => { preloader.initLoading() })
  document.addEventListener('pjax:complete', () => { preloader.endLoading() })
}</script><script>window.paceOptions = {
  restartOnPushState: false
}

btf.addGlobalFn('pjaxSend', () => {
  Pace.restart()
}, 'pace_restart')

</script><link rel="stylesheet" href="/css/progress_bar.css"/><script src="https://cdn.jsdelivr.net/npm/pace-js/pace.min.js"></script><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="https://ff09945.webp.li/watch_neko.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">5</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">2</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">1</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/Jeff/"><i class="fa-fw fas fa-female"></i><span> Jeff</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-list"></i><span> CS</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/BigData/"><i class="fa-fw fas fa-database"></i><span> BigData</span></a></li><li><a class="site-page child" href="/MachineLearning/"><i class="fa-fw fas fa-microchip-ai"></i><span> MachineLearning</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(https://ff09945.webp.li/MorishimaHaruka_3.png);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"></a><a class="nav-page-title" href="/"><span class="site-name">Kubernetes 安装</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/Jeff/"><i class="fa-fw fas fa-female"></i><span> Jeff</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-list"></i><span> CS</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/BigData/"><i class="fa-fw fas fa-database"></i><span> BigData</span></a></li><li><a class="site-page child" href="/MachineLearning/"><i class="fa-fw fas fa-microchip-ai"></i><span> MachineLearning</span></a></li></ul></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">Kubernetes 安装</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2023-11-10T16:00:00.000Z" title="发表于 2023-11-11 00:00:00">2023-11-11</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-03-14T07:58:06.653Z" title="更新于 2025-03-14 15:58:06">2025-03-14</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div><!-- display waves--><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><div id="post-outdate-notice" data="{&quot;limitDay&quot;:365,&quot;messagePrev&quot;:&quot;It has been&quot;,&quot;messageNext&quot;:&quot;days since the last update, the content of the article may be outdated.&quot;,&quot;postUpdate&quot;:&quot;2025-03-14 15:58:06&quot;}" hidden></div><h1 id="Kubernetes"><a href="#Kubernetes" class="headerlink" title="Kubernetes"></a>Kubernetes</h1><h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p>使用 kubeadm 安装 k8s 1.31.2</p>
<p>container runtime 选择 containerd或者cri-o</p>
<p>安装网络插件 calico，节点监控 Metrics-Server</p>
<h2 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h2><div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">节点</th>
<th style="text-align:center">系统</th>
<th style="text-align:center">IP</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">master</td>
<td style="text-align:center">centos7.9</td>
<td style="text-align:center">192.168.157.128</td>
</tr>
<tr>
<td style="text-align:center">node1</td>
<td style="text-align:center">centos7.9</td>
<td style="text-align:center">192.168.157.129</td>
</tr>
</tbody>
</table>
</div>
<h2 id="基本配置"><a href="#基本配置" class="headerlink" title="基本配置"></a>基本配置</h2><div class="note primary flat"><p>以下操作若无特殊说明，所有节点都进行操作</p>
</div>
<h3 id="安装所需软件"><a href="#安装所需软件" class="headerlink" title="安装所需软件"></a>安装所需软件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">CentOS7 操作</span></span><br><span class="line">yum -y install wget device-mapper-persistent-data lvm2 chrony sshpass ipvsadm ipset sysstat conntrack libseccomp curl</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Ubuntu 操作</span></span><br><span class="line">sudo apt-get update &amp;&amp; sudo apt-get install -y lvm2 chrony sshpass ipvsadm ipset sysstat conntrack apt-transport-https curl</span><br></pre></td></tr></table></figure>
<h3 id="关闭防火墙"><a href="#关闭防火墙" class="headerlink" title="关闭防火墙"></a>关闭防火墙</h3><p>在某些 Kubernetes 组件或插件中，可能会出现权限问题，特别是在运行旧版本时。关闭 SELinux 可以避免这些问题。</p>
<p>ubuntu 忽略</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">关闭防火墙</span></span><br><span class="line">systemctl disable --now firewalld</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">关闭 SELinux</span></span><br><span class="line">setenforce 0</span><br><span class="line">sed -i &#x27;s#SELINUX=enforcing#SELINUX=permissive#g&#x27; /etc/selinux/config</span><br></pre></td></tr></table></figure>
<h3 id="关闭-Swap"><a href="#关闭-Swap" class="headerlink" title="关闭 Swap"></a>关闭 Swap</h3><ul>
<li><strong>保证资源隔离</strong>：Kubernetes 使用 cgroups 来限制每个容器的资源使用，如 CPU 和内存。如果启用 swap，容器可能会超过其分配的内存限制，通过 swap 占用更多的内存资源，导致不准确的资源隔离。</li>
<li><strong>稳定性</strong>：在启用 swap 时，可能会引起调度的不稳定，容器在高负载时容易被杀死，影响应用的性能和稳定性。</li>
<li><strong>Kubelet 要求</strong>：Kubelet 默认会检查节点是否禁用了 swap，若未关闭，则会拒绝启动。为了避免这种情况，一般选择关闭 swap。</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 关闭交换分区</span><br><span class="line">sudo sed -ri &#x27;s/.*swap.*/#&amp;/&#x27; /etc/fstab</span><br><span class="line">sudo swapoff -a &amp;&amp; sysctl -w vm.swappiness=0</span><br></pre></td></tr></table></figure>
<h3 id="网络配置"><a href="#网络配置" class="headerlink" title="网络配置"></a>网络配置</h3><p>用于指定不由 NetworkManager 管理的设备，可以将特定的接口排除在 NetworkManager 的管理范围之外，以便其他工具或进程可以独立地管理和配置这些接口。</p>
<p>ubuntu 忽略</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/NetworkManager/conf.d/calico.conf &lt;&lt; EOF </span><br><span class="line">[keyfile]</span><br><span class="line">unmanaged-devices=interface-name:cali*;interface-name:tunl*</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">systemctl restart NetworkManager</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">interface-name:cali*</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">表示以 <span class="string">&quot;cali&quot;</span> 开头的接口名称被排除在 NetworkManager 管理之外。例如，<span class="string">&quot;cali0&quot;</span>, <span class="string">&quot;cali1&quot;</span> 等接口不受 NetworkManager 管理。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">interface-name:tunl*</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">表示以 <span class="string">&quot;tunl&quot;</span> 开头的接口名称被排除在 NetworkManager 管理之外。例如，<span class="string">&quot;tunl0&quot;</span>, <span class="string">&quot;tunl1&quot;</span> 等接口不受 NetworkManager 管理。</span></span><br></pre></td></tr></table></figure>
<h3 id="进行时间同步"><a href="#进行时间同步" class="headerlink" title="进行时间同步"></a>进行时间同步</h3><p>master 操作</p>
<p>将下方 <code>192.168.157.0/24</code> 换为你主机所在的网段  </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/chrony.conf &lt;&lt; EOF </span><br><span class="line">pool ntp.aliyun.com iburst</span><br><span class="line">driftfile /var/lib/chrony/drift</span><br><span class="line">makestep 1.0 3</span><br><span class="line">rtcsync</span><br><span class="line">allow 192.168.157.0/24 # 网段范围内的主机与chrony进行时间同步</span><br><span class="line">local stratum 10</span><br><span class="line">keyfile /etc/chrony.keys</span><br><span class="line">leapsectz right/UTC</span><br><span class="line">logdir /var/log/chrony</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">systemctl restart chronyd ; systemctl enable chronyd </span><br></pre></td></tr></table></figure>
<p>node 节点操作</p>
<p>将下方 <code>192.168.157.128</code> 修改为服务端节点</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/chrony.conf &lt;&lt; EOF </span><br><span class="line">pool 192.168.157.128 iburst</span><br><span class="line">driftfile /var/lib/chrony/drift</span><br><span class="line">makestep 1.0 3</span><br><span class="line">rtcsync</span><br><span class="line">keyfile /etc/chrony.keys</span><br><span class="line">leapsectz right/UTC</span><br><span class="line">logdir /var/log/chrony</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">systemctl restart chronyd ; systemctl enable chronyd </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">使用客户端进行验证</span></span><br><span class="line">chronyc sources -v</span><br></pre></td></tr></table></figure>
<h3 id="配置-ulimit"><a href="#配置-ulimit" class="headerlink" title="配置 ulimit"></a>配置 ulimit</h3><ul>
<li><strong>限制文件描述符数量</strong>：Kubernetes 中的节点和容器可能需要打开大量文件描述符（例如日志文件、网络连接等）。如果未设置足够高的文件描述符限制，可能会导致 <code>too many open files</code> 错误，影响服务的正常运行。</li>
<li><strong>控制进程数</strong>：在高负载的环境下，可能会有大量进程启动（如微服务环境中的多个 pod），这时需要对进程数限制进行合理配置，以防止系统因进程数过多而崩溃。</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">ulimit -SHn 65535</span><br><span class="line">cat &gt;&gt; /etc/security/limits.conf &lt;&lt;EOF</span><br><span class="line">* soft nofile 655360</span><br><span class="line">* hard nofile 131072</span><br><span class="line">* soft nproc 655350</span><br><span class="line">* hard nproc 655350</span><br><span class="line">* seft memlock unlimited</span><br><span class="line">* hard memlock unlimitedd</span><br><span class="line">EOF</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">soft nofile 655360</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">soft表示软限制，nofile表示一个进程可打开的最大文件数，默认值为1024。这里的软限制设置为655360，即一个进程可打开的最大文件数为655360。</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">hard nofile 131072</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">hard表示硬限制，即系统设置的最大值。nofile表示一个进程可打开的最大文件数，默认值为4096。这里的硬限制设置为131072，即系统设置的最大文件数为131072。</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">soft <span class="built_in">nproc</span> 655350</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">soft表示软限制，<span class="built_in">nproc</span>表示一个用户可创建的最大进程数，默认值为30720。这里的软限制设置为655350，即一个用户可创建的最大进程数为655350。</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">hard <span class="built_in">nproc</span> 655350</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">hard表示硬限制，即系统设置的最大值。<span class="built_in">nproc</span>表示一个用户可创建的最大进程数，默认值为4096。这里的硬限制设置为655350，即系统设置的最大进程数为655350。</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">seft memlock unlimited</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">seft表示软限制，memlock表示一个进程可锁定在RAM中的最大内存，默认值为64 KB。这里的软限制设置为unlimited，即一个进程可锁定的最大内存为无限制。</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">hard memlock unlimited</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">hard表示硬限制，即系统设置的最大值。memlock表示一个进程可锁定在RAM中的最大内存，默认值为64 KB。这里的硬限制设置为unlimited，即系统设置的最大内存锁定为无限制。</span></span><br></pre></td></tr></table></figure>
<h3 id="升级内核至4-18版本以上（可选）"><a href="#升级内核至4-18版本以上（可选）" class="headerlink" title="升级内核至4.18版本以上（可选）"></a>升级内核至4.18版本以上（可选）</h3><ul>
<li><strong>增强的容器支持</strong>：内核 4.18 引入了对 <code>cgroup v2</code>、<code>eBPF</code> 等特性的改进，这些特性能够优化 Kubernetes 的资源管理和监控。使用 <code>cgroup v2</code> 可以更好地隔离和管理容器资源，减少资源争用。</li>
<li><strong>性能优化</strong>：在高负载环境下，新内核引入的网络和存储优化可以显著提升 Kubernetes 集群的稳定性和性能。例如，<code>IPVS</code> 在 4.18 及更高版本中有更好的支持，可提高服务负载均衡的效率。</li>
<li><strong>安全增强</strong>：高版本内核包含一些安全补丁，有助于减少集群在面对现代漏洞（如 Meltdown、Spectre）时的风险，增强系统的整体安全性。</li>
</ul>
<p>ubuntu忽略</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">添加启用源</span></span><br><span class="line">yum install https://www.elrepo.org/elrepo-release-7.el7.elrepo.noarch.rpm -y </span><br><span class="line">sed -i &quot;s@mirrorlist@#mirrorlist@g&quot; /etc/yum.repos.d/elrepo.repo </span><br><span class="line">sed -i &quot;s@elrepo.org/linux@mirrors.tuna.tsinghua.edu.cn/elrepo@g&quot; /etc/yum.repos.d/elrepo.repo </span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">安装最新的内核</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">我这里选择的是稳定版 kernel-ml   如需更新长期维护版本 kernel-lt</span>  </span><br><span class="line">yum -y --enablerepo=elrepo-kernel  install  kernel-ml</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看已安装那些内核</span></span><br><span class="line">rpm -qa | grep kernel</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看默认内核</span></span><br><span class="line">grubby --default-kernel</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">若不是最新的使用命令设置</span></span><br><span class="line">grubby --set-default $(ls /boot/vmlinuz-* | grep elrepo)</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">重启生效</span></span><br><span class="line">reboot</span><br></pre></td></tr></table></figure>
<h3 id="安装-ipvsadm"><a href="#安装-ipvsadm" class="headerlink" title="安装 ipvsadm"></a>安装 ipvsadm</h3><ul>
<li><p><strong>高性能</strong>：IPVS（IP Virtual Server）相比默认的 <code>iptables</code> 模式在高并发场景下具有更好的性能，适合大型集群。</p>
</li>
<li><p><strong>低延迟</strong>：IPVS 使用 Linux 内核级别的负载均衡实现，延迟更低，支持轮询、最小连接数等多种调度算法，提升服务访问效率。</p>
</li>
<li><p><strong>管理和查看 IPVS 规则</strong>：虽然 IPVS 模式本身不依赖 <code>ipvsadm</code> 运行，但 <code>ipvsadm</code> 提供了查看和管理 IPVS 规则的功能。例如，可以通过 <code>ipvsadm -Ln</code> 命令列出当前的 IPVS 负载均衡规则，帮助运维人员排查网络问题。</p>
</li>
<li><p><strong>监控 IPVS 状态</strong>：可以查看当前连接数、路由等信息，便于调优和监控负载均衡状态。</p>
</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">yum install ipvsadm ipset sysstat conntrack libseccomp -y</span><br><span class="line">apt install ipvsadm ipset sysstat conntrack -y</span><br><span class="line"></span><br><span class="line">cat &gt;&gt; /etc/modules-load.d/ipvs.conf &lt;&lt;EOF </span><br><span class="line">ip_vs</span><br><span class="line">ip_vs_rr</span><br><span class="line">ip_vs_wrr</span><br><span class="line">ip_vs_sh</span><br><span class="line">nf_conntrack</span><br><span class="line">ip_tables</span><br><span class="line">ip_set</span><br><span class="line">xt_set</span><br><span class="line">ipt_set</span><br><span class="line">ipt_rpfilter</span><br><span class="line">ipt_REJECT</span><br><span class="line">ipip</span><br><span class="line">EOF</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">重载模块</span></span><br><span class="line">systemctl restart systemd-modules-load.service</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">检查配置</span></span><br><span class="line">lsmod | grep -e ip_vs -e nf_conntrack</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ip_vs</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">IPVS 是 Linux 内核中的一个模块，用于实现负载均衡和高可用性。它通过在前端代理服务器上分发传入请求到后端实际服务器上，提供了高性能和可扩展的网络服务。</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># ip_vs_rr</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">IPVS 的一种调度算法之一，使用轮询方式分发请求到后端服务器，每个请求按顺序依次分发。</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># ip_vs_wrr</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">IPVS 的一种调度算法之一，使用加权轮询方式分发请求到后端服务器，每个请求按照指定的权重比例分发。</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># ip_vs_sh</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">IPVS 的一种调度算法之一，使用哈希方式根据源 IP 地址和目标 IP 地址来分发请求。</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># nf_conntrack</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">这是一个内核模块，用于跟踪和管理网络连接，包括 TCP、UDP 和 ICMP 等协议。它是实现防火墙状态跟踪的基础。</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># ip_tables</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">这是一个内核模块，提供了对 Linux 系统 IP 数据包过滤和网络地址转换（NAT）功能的支持。</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># ip_set</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">这是一个内核模块，扩展了 iptables 的功能，支持更高效的 IP 地址集合操作。</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># xt_set</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">这是一个内核模块，扩展了 iptables 的功能，支持更高效的数据包匹配和操作。</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># ipt_set</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">这是一个用户空间工具，用于配置和管理 xt_set 内核模块。</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># ipt_rpfilter</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">这是一个内核模块，用于实现反向路径过滤，用于防止 IP 欺骗和 DDoS 攻击。</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># ipt_REJECT</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">这是一个 iptables 目标，用于拒绝 IP 数据包，并向发送方发送响应，指示数据包被拒绝。</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># ipip</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">这是一个内核模块，用于实现 IP 封装在 IP（IP-over-IP）的隧道功能。它可以在不同网络之间创建虚拟隧道来传输 IP 数据包。</span></span><br></pre></td></tr></table></figure>
<h3 id="修改内核参数"><a href="#修改内核参数" class="headerlink" title="修改内核参数"></a>修改内核参数</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt;EOF &gt; /etc/sysctl.d/k8s.conf</span><br><span class="line">net.ipv4.ip_forward = 1</span><br><span class="line">net.bridge.bridge-nf-call-iptables = 1</span><br><span class="line">fs.may_detach_mounts = 1</span><br><span class="line">vm.overcommit_memory=1</span><br><span class="line">vm.panic_on_oom=0</span><br><span class="line">fs.inotify.max_user_watches=89100</span><br><span class="line">fs.file-max=52706963</span><br><span class="line">fs.nr_open=52706963</span><br><span class="line">net.netfilter.nf_conntrack_max=2310720</span><br><span class="line"></span><br><span class="line">net.ipv4.tcp_keepalive_time = 600</span><br><span class="line">net.ipv4.tcp_keepalive_probes = 3</span><br><span class="line">net.ipv4.tcp_keepalive_intvl =15</span><br><span class="line">net.ipv4.tcp_max_tw_buckets = 36000</span><br><span class="line">net.ipv4.tcp_tw_reuse = 1</span><br><span class="line">net.ipv4.tcp_max_orphans = 327680</span><br><span class="line">net.ipv4.tcp_orphan_retries = 3</span><br><span class="line">net.ipv4.tcp_syncookies = 1</span><br><span class="line">net.ipv4.tcp_max_syn_backlog = 16384</span><br><span class="line">net.ipv4.tcp_timestamps = 0</span><br><span class="line">net.core.somaxconn = 16384</span><br><span class="line"></span><br><span class="line">net.ipv6.conf.all.disable_ipv6 = 0</span><br><span class="line">net.ipv6.conf.default.disable_ipv6 = 0</span><br><span class="line">net.ipv6.conf.lo.disable_ipv6 = 0</span><br><span class="line">net.ipv6.conf.all.forwarding = 1</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">modprobe br_netfilter</span><br><span class="line">sysctl -p /etc/sysctl.d/k8s.conf</span><br><span class="line">sysctl --system</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">这些是Linux系统的一些参数设置，用于配置和优化网络、文件系统和虚拟内存等方面的功能。以下是每个参数的详细解释：</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 1. net.ipv4.ip_forward = 1</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">   - 这个参数启用了IPv4的IP转发功能，允许服务器作为网络路由器转发数据包。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 2. net.bridge.bridge-nf-call-iptables = 1</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">   - 当使用网络桥接技术时，将数据包传递到iptables进行处理。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"> </span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">3. fs.may_detach_mounts = 1</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">   - 允许在挂载文件系统时，允许被其他进程使用。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"> </span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">4. vm.overcommit_memory=1</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">   - 该设置允许原始的内存过量分配策略，当系统的内存已经被完全使用时，系统仍然会分配额外的内存。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 5. vm.panic_on_oom=0</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">   - 当系统内存不足（OOM）时，禁用系统崩溃和重启。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 6. fs.inotify.max_user_watches=89100</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">   - 设置系统允许一个用户的inotify实例可以监控的文件数目的上限。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 7. fs.file-max=52706963</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">   - 设置系统同时打开的文件数的上限。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 8. fs.nr_open=52706963</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">   - 设置系统同时打开的文件描述符数的上限。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 9. net.netfilter.nf_conntrack_max=2310720</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">   - 设置系统可以创建的网络连接跟踪表项的最大数量。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 10. net.ipv4.tcp_keepalive_time = 600</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">    - 设置TCP套接字的空闲超时时间（秒），超过该时间没有活动数据时，内核会发送心跳包。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 11. net.ipv4.tcp_keepalive_probes = 3</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">    - 设置未收到响应的TCP心跳探测次数。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 12. net.ipv4.tcp_keepalive_intvl = 15</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">    - 设置TCP心跳探测的时间间隔（秒）。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 13. net.ipv4.tcp_max_tw_buckets = 36000</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">    - 设置系统可以使用的TIME_WAIT套接字的最大数量。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 14. net.ipv4.tcp_tw_reuse = 1</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">    - 启用TIME_WAIT套接字的重新利用，允许新的套接字使用旧的TIME_WAIT套接字。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 15. net.ipv4.tcp_max_orphans = 327680</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">    - 设置系统可以同时存在的TCP套接字垃圾回收包裹数的最大数量。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 16. net.ipv4.tcp_orphan_retries = 3</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">    - 设置系统对于孤立的TCP套接字的重试次数。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 17. net.ipv4.tcp_syncookies = 1</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">    - 启用TCP SYN cookies保护，用于防止SYN洪泛攻击。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 18. net.ipv4.tcp_max_syn_backlog = 16384</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">    - 设置新的TCP连接的半连接数（半连接队列）的最大长度。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 19. net.ipv4.ip_conntrack_max = 65536</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">    - 设置系统可以创建的网络连接跟踪表项的最大数量。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 20. net.ipv4.tcp_timestamps = 0</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">    - 关闭TCP时间戳功能，用于提供更好的安全性。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 21. net.core.somaxconn = 16384</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">    - 设置系统核心层的连接队列的最大值。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 22. net.ipv6.conf.all.disable_ipv6 = 0</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">    - 启用IPv6协议。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 23. net.ipv6.conf.default.disable_ipv6 = 0</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">    - 启用IPv6协议。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 24. net.ipv6.conf.lo.disable_ipv6 = 0</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">    - 启用IPv6协议。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 25. net.ipv6.conf.all.forwarding = 1</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">    - 允许IPv6数据包转发。</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">modprobe br_netfilter 该命令加载 br_netfilter 内核模块，该模块允许桥接接口的过滤功能（通常是处理网络包）。它是启用 Kubernetes 集群的容器网络功能（如网络策略）的必要模块，特别是在节点上使用桥接网络时。</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">sysctl -p /etc/sysctl.d/k8s.conf</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">该命令应用 /etc/sysctl.d/k8s.conf 配置文件中的内核参数。通常，该文件包含与 Kubernetes 和容器网络相关的配置，类似于启用 IP 转发（net.ipv4.ip_forward）和其他网络优化设置。</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">sysctl --system</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">该命令重新加载所有的 sysctl 配置文件，通常是 /etc/sysctl.conf 和 /etc/sysctl.d/ 目录下的所有配置文件。它应用系统级别的内核参数设置，以确保系统的内核配置符合预期。</span></span><br></pre></td></tr></table></figure>
<h3 id="所有节点配置-hosts-本地解析"><a href="#所有节点配置-hosts-本地解析" class="headerlink" title="所有节点配置 hosts 本地解析"></a>所有节点配置 hosts 本地解析</h3><p>修改 <code>/etc/hosts</code> 文件，新增节点</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">192.168.157.128 master</span><br><span class="line">192.168.157.129 node1</span><br></pre></td></tr></table></figure>
<h2 id="配置容器"><a href="#配置容器" class="headerlink" title="配置容器"></a>配置容器</h2><p><code>containerd</code> 或者 <code>cri-o</code> 二选一</p>
<h3 id="配置containerd"><a href="#配置containerd" class="headerlink" title="配置containerd"></a>配置containerd</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">下载所需应用包</span></span><br><span class="line">wget https://github.com/containerd/containerd/releases/download/v1.7.18/cri-containerd-cni-1.7.18-linux-amd64.tar.gz</span><br><span class="line">wget https://github.com/containernetworking/plugins/releases/download/v1.5.1/cni-plugins-linux-amd64-v1.5.1.tgz</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">centos7 要升级libseccomp</span></span><br><span class="line">yum -y install https://yum.oracle.com/repo/OracleLinux/OL8/baseos/latest/x86_64/getPackage/libseccomp-2.5.1-1.el8.x86_64.rpm</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">创建cni插件所需目录</span></span><br><span class="line">mkdir -p /etc/cni/net.d /opt/cni/bin </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">解压cni二进制包</span></span><br><span class="line">tar xf cni-plugins-linux-amd64-v*.tgz -C /opt/cni/bin/</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">解压</span></span><br><span class="line">tar -xzf cri-containerd-cni-*-linux-amd64.tar.gz -C /</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">创建服务启动文件</span></span><br><span class="line">cat &gt; /etc/systemd/system/containerd.service &lt;&lt;EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=containerd container runtime</span><br><span class="line">Documentation=https://containerd.io</span><br><span class="line">After=network.target local-fs.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">ExecStartPre=-/sbin/modprobe overlay</span><br><span class="line">ExecStart=/usr/local/bin/containerd</span><br><span class="line">Type=notify</span><br><span class="line">Delegate=yes</span><br><span class="line">KillMode=process</span><br><span class="line">Restart=always</span><br><span class="line">RestartSec=5</span><br><span class="line">LimitNPROC=infinity</span><br><span class="line">LimitCORE=infinity</span><br><span class="line">LimitNOFILE=infinity</span><br><span class="line">TasksMax=infinity</span><br><span class="line">OOMScoreAdjust=-999</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<h4 id="配置内核"><a href="#配置内核" class="headerlink" title="配置内核"></a>配置内核</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">配置 Containerd 所需的模块</span></span><br><span class="line">cat &lt;&lt;EOF | sudo tee /etc/modules-load.d/containerd.conf</span><br><span class="line">overlay</span><br><span class="line">br_netfilter</span><br><span class="line">EOF</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">加载模块</span></span><br><span class="line">systemctl restart systemd-modules-load.service</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">配置 Containerd 所需的内核</span></span><br><span class="line">cat &lt;&lt;EOF | sudo tee /etc/sysctl.d/99-kubernetes-cri.conf</span><br><span class="line">net.bridge.bridge-nf-call-iptables  = 1</span><br><span class="line">net.ipv4.ip_forward                 = 1</span><br><span class="line">net.bridge.bridge-nf-call-ip6tables = 1</span><br><span class="line">EOF</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">加载内核</span></span><br><span class="line">sysctl --system</span><br></pre></td></tr></table></figure>
<h4 id="修改默认配置"><a href="#修改默认配置" class="headerlink" title="修改默认配置"></a>修改默认配置</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /etc/containerd</span><br><span class="line">containerd config default | tee /etc/containerd/config.toml</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">修改 Containerd 的配置文件</span></span><br><span class="line">sed -i &quot;s#SystemdCgroup\ \=\ false#SystemdCgroup\ \=\ true#g&quot; /etc/containerd/config.toml</span><br><span class="line">cat /etc/containerd/config.toml | grep SystemdCgroup</span><br><span class="line">sed -i &quot;s#registry.k8s.io/pause:3.8#k8s.m.daocloud.io/pause:3.10#g&quot; /etc/containerd/config.toml</span><br><span class="line">cat /etc/containerd/config.toml | grep sandbox_image</span><br><span class="line">sed -i &quot;s#config_path\ \=\ \&quot;\&quot;#config_path\ \=\ \&quot;/etc/containerd/certs.d\&quot;#g&quot; /etc/containerd/config.toml</span><br><span class="line">cat /etc/containerd/config.toml | grep certs.d</span><br></pre></td></tr></table></figure>
<h4 id="配置加速器"><a href="#配置加速器" class="headerlink" title="配置加速器"></a>配置加速器</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">配置加速器</span></span><br><span class="line">mkdir /etc/containerd/certs.d/docker.io -pv</span><br><span class="line">cat &gt; /etc/containerd/certs.d/docker.io/hosts.toml &lt;&lt; EOF</span><br><span class="line">server = &quot;https://docker.io&quot;</span><br><span class="line">[host.&quot;https://docker.m.daocloud.io&quot;]</span><br><span class="line">  capabilities = [&quot;pull&quot;, &quot;resolve&quot;]</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">mkdir /etc/containerd/certs.d/registry.k8s.io -pv</span><br><span class="line">cat &gt; /etc/containerd/certs.d/registry.k8s.io/hosts.toml &lt;&lt; EOF</span><br><span class="line">server = &quot;https://registry.k8s.io&quot;</span><br><span class="line">[host.&quot;https://k8s.m.daocloud.io&quot;]</span><br><span class="line">  capabilities = [&quot;pull&quot;, &quot;resolve&quot;]</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<h4 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启动并设置为开机启动</span></span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl enable --now containerd.service</span><br><span class="line">systemctl stop containerd.service</span><br><span class="line">systemctl start containerd.service</span><br><span class="line">systemctl restart containerd.service</span><br><span class="line">systemctl status containerd.service</span><br></pre></td></tr></table></figure>
<h3 id="配置CRI-O"><a href="#配置CRI-O" class="headerlink" title="配置CRI-O"></a>配置CRI-O</h3><h4 id="配置内核-1"><a href="#配置内核-1" class="headerlink" title="配置内核"></a>配置内核</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">配置 CRI-O 所需的模块</span></span><br><span class="line">cat &gt; /etc/modules-load.d/crio.conf &lt;&lt; EOF</span><br><span class="line">overlay</span><br><span class="line">br_netfilter</span><br><span class="line">EOF</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">加载模块</span></span><br><span class="line">modprobe overlay</span><br><span class="line">systemctl restart systemd-modules-load.service</span><br></pre></td></tr></table></figure>
<h4 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">VERSION=1.28</span><br><span class="line">OS=CentOS_7</span><br><span class="line"></span><br><span class="line">curl -L -o /etc/yum.repos.d/devel:kubic:libcontainers:stable.repo https://download.opensuse.org/repositories/devel:/kubic:/libcontainers:/stable/$OS/devel:kubic:libcontainers:stable.repo</span><br><span class="line"></span><br><span class="line">curl -L -o /etc/yum.repos.d/devel:kubic:libcontainers:stable:cri-o:$VERSION.repo https://download.opensuse.org/repositories/devel:kubic:libcontainers:stable:cri-o:$VERSION/$OS/devel:kubic:libcontainers:stable:cri-o:$VERSION.repo</span><br><span class="line"></span><br><span class="line">yum install -y cri-o</span><br></pre></td></tr></table></figure>
<h4 id="修改配置"><a href="#修改配置" class="headerlink" title="修改配置"></a>修改配置</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/crio/crio.conf</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">修改 pause_image</span> </span><br><span class="line">pause_image = &quot;k8s.m.daocloud.io/pause:3.10&quot;</span><br><span class="line"></span><br><span class="line">vi /etc/containers/registries.conf</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">修改 unqualified-search-registries</span></span><br><span class="line">unqualified-search-registries = [&quot;docker.m.daocloud.io&quot;, &quot;k8s.m.daocloud.io&quot;]</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启动并设置为开机启动</span></span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl enable --now crio.service</span><br><span class="line">systemctl stop crio.service</span><br><span class="line">systemctl start crio.service</span><br><span class="line">systemctl restart crio.service</span><br><span class="line">systemctl status crio.service</span><br></pre></td></tr></table></figure>
<h2 id="配置安装源"><a href="#配置安装源" class="headerlink" title="配置安装源"></a>配置安装源</h2><p>Kubernetes 是一个开源系统，用于容器化应用的自动部署、扩缩和管理。它将构成应用的容器按逻辑单位进行分组以便于管理和发现。</p>
<p>由于 Kubernetes 官方变更了仓库的存储路径以及使用方式，如果需要使用 1.28 及以上版本，请使用 新版配置方法 进行配置。</p>
<p>centos</p>
<p>注意修改为自己需要的版本号</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt;EOF | tee /etc/yum.repos.d/kubernetes.repo</span><br><span class="line">[kubernetes]</span><br><span class="line">name=Kubernetes</span><br><span class="line">baseurl=https://mirrors.aliyun.com/kubernetes-new/core/stable/v1.31/rpm/</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=1</span><br><span class="line">gpgkey=https://mirrors.aliyun.com/kubernetes-new/core/stable/v1.31/rpm/repodata/repomd.xml.key</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">yum update -y &amp;&amp; yum install -y kubelet kubeadm kubectl</span><br><span class="line"></span><br><span class="line">systemctl enable kubelet &amp;&amp; systemctl start kubelet</span><br></pre></td></tr></table></figure>
<h3 id="修改镜像"><a href="#修改镜像" class="headerlink" title="修改镜像"></a>修改镜像</h3><p>coredns 镜像名在拉取的时候有名称问题，需要修改名称</p>
<p>如果使用 CRI-O，请使用 podman 更改镜像</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看最新版本有那些镜像</span></span><br><span class="line">kubeadm config images list --image-repository k8s.m.daocloud.io</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">拉取镜像</span></span><br><span class="line">ctr --namespace k8s.io images pull k8s.m.daocloud.io/coredns/coredns:v1.11.3</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">修改镜像名称</span></span><br><span class="line">ctr --namespace k8s.io images tag k8s.m.daocloud.io/coredns/coredns:v1.11.3 k8s.m.daocloud.io/coredns:v1.11.3</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看镜像</span></span><br><span class="line">ctr --namespace k8s.io images ls | grep coredns</span><br></pre></td></tr></table></figure>
<h3 id="修改初始化配置"><a href="#修改初始化配置" class="headerlink" title="修改初始化配置"></a>修改初始化配置</h3><p>master 节点操作</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">生成默认配置</span></span><br><span class="line">kubeadm config print init-defaults &gt; kubeadm.yaml</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">修改以下内容</span></span><br><span class="line">localAPIEndpoint:</span><br><span class="line">  advertiseAddress: 192.168.157.128 # 修改为 master IP</span><br><span class="line">nodeRegistration:</span><br><span class="line">  criSocket: unix:///var/run/containerd/containerd.sock # 如果为 containerd 则不需要修改，如果是 CRI-O，则修改为unix:///var/run/crio/crio.sock</span><br><span class="line">  name: master # 修改为 master 的主机名</span><br><span class="line">  </span><br><span class="line">imageRepository: k8s.m.daocloud.io # 修改镜像加速</span><br><span class="line">kubernetesVersion: 1.31.2 # 修改镜像版本</span><br><span class="line"></span><br><span class="line">podSubnet: 172.16.0.0/12 # 在 dnsDomain: cluster.local 下添加</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">在最末尾添加以下内容</span></span><br><span class="line">---</span><br><span class="line">apiVersion: kubeproxy.config.k8s.io/v1alpha1</span><br><span class="line">kind: KubeProxyConfiguration</span><br><span class="line">mode: ipvs</span><br><span class="line">---</span><br><span class="line">apiVersion: kubelet.config.k8s.io/v1beta1</span><br><span class="line">kind: KubeletConfiguration</span><br><span class="line">cgroupDriver: systemd</span><br></pre></td></tr></table></figure>
<h2 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h2><p>master 节点上操作</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">初始化 k8s</span></span><br><span class="line">kubeadm init --config=kubeadm.yaml</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">配置config</span></span><br><span class="line">mkdir -p $HOME/.kube</span><br><span class="line">cp -i /etc/kubernetes/admin.conf $HOME/.kube/config</span><br><span class="line">chown $(id -u):$(id -g) $HOME/.kube/config</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">重新初始化</span></span><br><span class="line">kubeadm reset</span><br></pre></td></tr></table></figure>
<p>node 节点运行</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">在node上执行操作，将加入工作节点</span></span><br><span class="line">cat &gt; kubeadm-join-node.yaml &lt;&lt; EOF</span><br><span class="line">apiVersion: kubeadm.k8s.io/v1beta3</span><br><span class="line">kind: JoinConfiguration</span><br><span class="line">discovery:</span><br><span class="line">  bootstrapToken:</span><br><span class="line">    apiServerEndpoint: 192.168.157.128:6443 # 这里修改为master的ip加对应的绑定端口</span><br><span class="line">    token: &quot;abcdef.0123456789abcdef&quot; # 这里修改为master的k8s初始化配置文件中的token</span><br><span class="line">    caCertHashes:</span><br><span class="line">    - &quot;sha256:e614d994febfbebd58d8c78df839532ddabb05b5f3466fdf0018546fc010c9a0&quot;</span><br><span class="line">    # 请更改上面的认证信息，使之与你的集群中实际使用的令牌和 CA 证书匹配</span><br><span class="line">nodeRegistration:</span><br><span class="line">  kubeletExtraArgs:</span><br><span class="line">    node-ip: 192.168.157.129 # 这里修改为node的IP</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">kubeadm join --config=kubeadm-join-node.yaml</span><br></pre></td></tr></table></figure>
<h2 id="配置-Calico"><a href="#配置-Calico" class="headerlink" title="配置 Calico"></a>配置 Calico</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">wget https://raw.githubusercontent.com/projectcalico/calico/refs/heads/master/manifests/calico-typha.yaml</span><br><span class="line"></span><br><span class="line">vi calico-typha.yaml</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">修改 CALICO_IPV4POOL_CIDR 配置</span></span><br><span class="line">    - name: CALICO_IPV4POOL_CIDR</span><br><span class="line">      value: &quot;172.16.0.0/12&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">切换国内仓库</span></span><br><span class="line">sed -i &quot;s#docker.io/calico/#docker.m.daocloud.io/calico/#g&quot; calico-typha.yaml </span><br><span class="line"></span><br><span class="line">kubectl apply -f calico-typha.yaml</span><br></pre></td></tr></table></figure>
<h2 id="配置-Metrics-Server"><a href="#配置-Metrics-Server" class="headerlink" title="配置 Metrics-Server"></a>配置 Metrics-Server</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/kubernetes-sigs/metrics-server/releases/latest/download/components.yaml</span><br><span class="line"></span><br><span class="line">vim components.yaml</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">添加- --kubelet-insecure-tls</span></span><br><span class="line">	  - args:</span><br><span class="line">        - --cert-dir=/tmp</span><br><span class="line">        - --secure-port=10250</span><br><span class="line">        - --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname</span><br><span class="line">        - --kubelet-use-node-status-port</span><br><span class="line">        - --metric-resolution=15s</span><br><span class="line">        - --kubelet-insecure-tls</span><br><span class="line">      </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">修改镜像地址</span></span><br><span class="line">sed -i &quot;s#registry.k8s.io#k8s.m.daocloud.io#g&quot; components.yaml</span><br><span class="line">cat components.yaml | grep image</span><br><span class="line"></span><br><span class="line">kubectl apply -f components.yaml</span><br><span class="line"></span><br><span class="line">kubectl  top node</span><br></pre></td></tr></table></figure>
<h2 id="配置命令行自动补全功能"><a href="#配置命令行自动补全功能" class="headerlink" title="配置命令行自动补全功能"></a>配置命令行自动补全功能</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">yum install bash-completion -y</span><br><span class="line">source /usr/share/bash-completion/bash_completion</span><br><span class="line">source &lt;(kubectl completion bash)</span><br><span class="line">echo &quot;source &lt;(kubectl completion bash)&quot; &gt;&gt; ~/.bashrc</span><br></pre></td></tr></table></figure>
<h1 id="HELM"><a href="#HELM" class="headerlink" title="HELM"></a>HELM</h1><h2 id="介绍-1"><a href="#介绍-1" class="headerlink" title="介绍"></a>介绍</h2><p>Helm 安装 <em>charts</em> 到 Kubernetes 集群中，每次安装都会创建一个新的 <em>release</em>。你可以在 Helm 的 chart <em>repositories</em> 中寻找新的 chart。<sup><a href="#fn_12" id="reffn_12">12</a></sup></p>
<p><em>Chart</em> 代表着 Helm 包。它包含在 Kubernetes 集群内部运行应用程序，工具或服务所需的所有资源定义。你可以把它看作是 Homebrew formula，Apt dpkg，或 Yum RPM 在Kubernetes 中的等价物。</p>
<p><em>Repository（仓库）</em> 是用来存放和共享 charts 的地方。它就像 Perl 的 <a target="_blank" rel="noopener" href="https://www.cpan.org/">CPAN 档案库网络</a> 或是 Fedora 的 <a target="_blank" rel="noopener" href="https://src.fedoraproject.org/">软件包仓库</a>，只不过它是供 Kubernetes 包所使用的。</p>
<p><em>Release</em> 是运行在 Kubernetes 集群中的 chart 的实例。一个 chart 通常可以在同一个集群中安装多次。每一次安装都会创建一个新的 <em>release</em>。以 MySQL chart为例，如果你想在你的集群中运行两个数据库，你可以安装该chart两次。每一个数据库都会拥有它自己的 <em>release</em> 和 <em>release name</em>。</p>
<h2 id="安装HELM"><a href="#安装HELM" class="headerlink" title="安装HELM"></a>安装HELM</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget https://mirrors.huaweicloud.com/helm/v3.16.3/helm-v3.16.3-linux-amd64.tar.gz</span><br><span class="line">tar xvf helm-*-linux-amd64.tar.gz</span><br><span class="line">cp linux-amd64/helm /usr/local/bin/</span><br></pre></td></tr></table></figure>
<h2 id="操作HELM"><a href="#操作HELM" class="headerlink" title="操作HELM"></a>操作HELM</h2><h3 id="查找-charts"><a href="#查找-charts" class="headerlink" title="查找 charts"></a>查找 charts</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">helm search hub [app_name] # 从 Artifact Hub 中查找并列出 helm charts。 Artifact Hub中存放了大量不同的仓库。</span><br><span class="line">helm search repo [repo_name|app_name] # 从你添加（使用 helm repo add）到本地 helm 客户端中的仓库中进行查找。该命令基于本地数据进行搜索，无需连接互联网。</span><br></pre></td></tr></table></figure>
<h3 id="安装前自定义-chart"><a href="#安装前自定义-chart" class="headerlink" title="安装前自定义 chart"></a>安装前自定义 chart</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm show values [app_name] # 可以查看 chart 中的可配置选项</span><br></pre></td></tr></table></figure>
<p>你可以使用 YAML 格式的文件覆盖上述任意配置项，并在安装过程中使用该文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">echo &#x27;&#123;mariadb.auth.database: user0db, mariadb.auth.username: user0&#125;&#x27; &gt; values.yaml</span><br><span class="line">helm install -f values.yaml bitnami/wordpress --generate-name</span><br></pre></td></tr></table></figure>
<p>上述命令将为 MariaDB 创建一个名称为 <code>user0</code> 的默认用户，并且授予该用户访问新建的 <code>user0db</code> 数据库的权限。chart 中的其他默认配置保持不变。<code>--generate-name</code>随机生成release名字</p>
<p>安装过程中有两种方式传递配置数据：</p>
<ul>
<li><code>--values</code> (或 <code>-f</code>)：使用 YAML 文件覆盖配置。可以指定多次，优先使用最右边的文件。</li>
<li><code>--set</code>：通过命令行的方式对指定项进行覆盖。</li>
</ul>
<p>如果同时使用两种方式，则 <code>--set</code> 中的值会被合并到 <code>--values</code> 中，但是 <code>--set</code> 中的值优先级更高。在<code>--set</code> 中覆盖的内容会被被保存在 ConfigMap 中。可以通过 <code>helm get values &lt;release-name&gt;</code> 来查看指定 release 中 <code>--set</code> 设置的值。也可以通过运行 <code>helm upgrade</code> 并指定 <code>--reset-values</code> 字段来清除 <code>--set</code> 中设置的值。</p>
<h3 id="追踪-release-的状态"><a href="#追踪-release-的状态" class="headerlink" title="追踪 release 的状态"></a>追踪 release 的状态</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm status &lt;release&gt; -n &lt;namespace&gt;</span><br></pre></td></tr></table></figure>
<h3 id="更多安装方法"><a href="#更多安装方法" class="headerlink" title="更多安装方法"></a>更多安装方法</h3><p><code>helm install</code> 命令可以从多个来源进行安装：</p>
<ul>
<li>chart 的仓库（如上所述）</li>
<li>本地 chart 压缩包（<code>helm install foo foo-0.1.1.tgz</code>）</li>
<li>解压后的 chart 目录（<code>helm install foo path/to/foo</code>）</li>
<li>完整的 URL（<code>helm install foo https://example.com/charts/foo-1.2.3.tgz</code>）</li>
</ul>
<h3 id="升级-release"><a href="#升级-release" class="headerlink" title="升级 release"></a>升级 release</h3><p>当你想升级到 chart 的新版本，或是修改 release 的配置，你可以使用 <code>helm upgrade</code> 命令。</p>
<p>一次升级操作会使用已有的 release 并根据你提供的信息对其进行升级。由于 Kubernetes 的 chart 可能会很大而且很复杂，Helm 会尝试执行最小侵入式升级。即它只会更新自上次发布以来发生了更改的内容。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm upgrade -f panda.yaml happy-panda bitnami/wordpress</span><br></pre></td></tr></table></figure>
<p><code>happy-panda</code> 这个 release 使用相同的 chart 进行升级，但是使用了一个新的 YAML 文件</p>
<p>可以使用 <code>helm get values</code> 命令来看看配置值是否真的生效了</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm get values happy-panda</span><br></pre></td></tr></table></figure>
<h3 id="失败时恢复"><a href="#失败时恢复" class="headerlink" title="失败时恢复"></a>失败时恢复</h3><p>在一次发布过程中，发生了不符合预期的事情，也很容易通过 <code>helm rollback [RELEASE] [REVISION]</code> 命令回滚到之前的发布版本。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm rollback happy-panda 1</span><br></pre></td></tr></table></figure>
<p>上面这条命令将我们的 <code>happy-panda</code> 回滚到了它最初的版本。release 版本其实是一个增量修订（revision）。 每当发生了一次安装、升级或回滚操作，revision 的值就会加1。第一次 revision 的值永远是1。我们可以使用 <code>helm history [RELEASE]</code> 命令来查看一个特定 release 的修订版本号。</p>
<h3 id="卸载-release"><a href="#卸载-release" class="headerlink" title="卸载 release"></a>卸载 release</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm uninstall happy-panda</span><br></pre></td></tr></table></figure>
<p>可以通过 <code>helm list</code> 命令看到当前部署的所有 release</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm list -n &lt;namespace&gt;</span><br></pre></td></tr></table></figure>
<p>在 Helm 3 中，删除会移除 release 的记录。 如果你想保留删除记录，使用 <code>helm uninstall --keep-history</code>。使用 <code>helm list --uninstalled</code> 只会展示使用了 <code>--keep-history</code> 删除的 release。</p>
<p><code>helm list --all</code> 会展示 Helm 保留的所有 release 记录，包括失败或删除的条目（指定了 <code>--keep-history</code>）</p>
<h3 id="使用仓库"><a href="#使用仓库" class="headerlink" title="使用仓库"></a>使用仓库</h3><p>Helm 3 不再附带一个默认的 chart 仓库。<code>helm repo</code> 提供了一组命令用于添加、列出和移除仓库。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">helm repo list # 查看配置的仓库</span><br><span class="line">helm repo add dev https://example.com/dev-charts # 添加新的仓库</span><br><span class="line">helm repo update # 确保你的 Helm 客户端是最新的</span><br><span class="line">helm repo remove # 移除仓库</span><br></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/home/">Kubernetes Documentation | Kubernetes</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/cby-chen/Kubernetes?tab=readme-ov-file">cby-chen/Kubernetes: kubernetes (k8s) 二进制高可用安装</a></p>
<p><a target="_blank" rel="noopener" href="https://oraclelinux.pkgs.org/8/ol8-baseos-latest-x86_64/libseccomp-2.5.1-1.el8.x86_64.rpm.html">libseccomp-2.5.1-1.el8.x86_64.rpm Oracle Linux 8 Download</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/DaoCloud/public-image-mirror">DaoCloud/public-image-mirror</a></p>
<p><a target="_blank" rel="noopener" href="https://mirrors.aliyun.com/kubernetes-new/">kubernetes-new安装包下载_开源镜像站-阿里云</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/containerd/containerd">containerd/containerd: An open and reliable container runtime</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/containernetworking/plugins">containernetworking/plugins: Some reference and example networking plugins, maintained by the CNI team.</a></p>
<p><a target="_blank" rel="noopener" href="https://mirrors.aliyun.com/kubernetes-new/core/stable/">kubernetes-new-core-stable安装包下载_开源镜像站-阿里云</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/projectcalico/calico/blob/master/manifests/calico-typha.yaml">calico/manifests/calico-typha.yaml at master · projectcalico/calico</a></p>
<p><a target="_blank" rel="noopener" href="https://mirrors.huaweicloud.com/helm/">Index of helm-local</a></p>
<p><a target="_blank" rel="noopener" href="https://kubernetes.github.io/dashboard/">Installation | dashboard</a></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://blog.rishinyan.top">Rishinyan</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://blog.rishinyan.top/Kubernetes/">https://blog.rishinyan.top/Kubernetes/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://blog.rishinyan.top" target="_blank">Rishinyan</a>！</span></div></div><div class="tag_share"><div class="post-share"><div class="social-share" data-image="https://ff09945.webp.li/MorishimaHaruka_3.png" data-sites="twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="gitalk-container"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="https://ff09945.webp.li/watch_neko.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">Rishinyan</div><div class="author-info-description">Rishinyan's Blog</div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">5</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">2</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">1</div></a></div><div class="card-info-social-icons"><a class="social-icon" href="https://github.com/hentaiacg" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="mailto:shinyanri@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #4a7dbe;"></i></a><a class="social-icon" href="/atom.xml" target="_blank" title=""><i class="fas fa-rss"></i></a><a class="social-icon" href="https://weibo.com/u/3219469802" target="_blank" title="Weibo"><i class="fab fa-weibo" style="color: #d70f0f;"></i></a></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Kubernetes"><span class="toc-number">1.</span> <span class="toc-text">Kubernetes</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.1.</span> <span class="toc-text">介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83"><span class="toc-number">1.2.</span> <span class="toc-text">环境</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E9%85%8D%E7%BD%AE"><span class="toc-number">1.3.</span> <span class="toc-text">基本配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E6%89%80%E9%9C%80%E8%BD%AF%E4%BB%B6"><span class="toc-number">1.3.1.</span> <span class="toc-text">安装所需软件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B3%E9%97%AD%E9%98%B2%E7%81%AB%E5%A2%99"><span class="toc-number">1.3.2.</span> <span class="toc-text">关闭防火墙</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B3%E9%97%AD-Swap"><span class="toc-number">1.3.3.</span> <span class="toc-text">关闭 Swap</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BD%91%E7%BB%9C%E9%85%8D%E7%BD%AE"><span class="toc-number">1.3.4.</span> <span class="toc-text">网络配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%9B%E8%A1%8C%E6%97%B6%E9%97%B4%E5%90%8C%E6%AD%A5"><span class="toc-number">1.3.5.</span> <span class="toc-text">进行时间同步</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE-ulimit"><span class="toc-number">1.3.6.</span> <span class="toc-text">配置 ulimit</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8D%87%E7%BA%A7%E5%86%85%E6%A0%B8%E8%87%B34-18%E7%89%88%E6%9C%AC%E4%BB%A5%E4%B8%8A%EF%BC%88%E5%8F%AF%E9%80%89%EF%BC%89"><span class="toc-number">1.3.7.</span> <span class="toc-text">升级内核至4.18版本以上（可选）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85-ipvsadm"><span class="toc-number">1.3.8.</span> <span class="toc-text">安装 ipvsadm</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E5%86%85%E6%A0%B8%E5%8F%82%E6%95%B0"><span class="toc-number">1.3.9.</span> <span class="toc-text">修改内核参数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%80%E6%9C%89%E8%8A%82%E7%82%B9%E9%85%8D%E7%BD%AE-hosts-%E6%9C%AC%E5%9C%B0%E8%A7%A3%E6%9E%90"><span class="toc-number">1.3.10.</span> <span class="toc-text">所有节点配置 hosts 本地解析</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E5%AE%B9%E5%99%A8"><span class="toc-number">1.4.</span> <span class="toc-text">配置容器</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AEcontainerd"><span class="toc-number">1.4.1.</span> <span class="toc-text">配置containerd</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E5%86%85%E6%A0%B8"><span class="toc-number">1.4.1.1.</span> <span class="toc-text">配置内核</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E9%BB%98%E8%AE%A4%E9%85%8D%E7%BD%AE"><span class="toc-number">1.4.1.2.</span> <span class="toc-text">修改默认配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E5%8A%A0%E9%80%9F%E5%99%A8"><span class="toc-number">1.4.1.3.</span> <span class="toc-text">配置加速器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8"><span class="toc-number">1.4.1.4.</span> <span class="toc-text">启动</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AECRI-O"><span class="toc-number">1.4.2.</span> <span class="toc-text">配置CRI-O</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E5%86%85%E6%A0%B8-1"><span class="toc-number">1.4.2.1.</span> <span class="toc-text">配置内核</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%89%E8%A3%85"><span class="toc-number">1.4.2.2.</span> <span class="toc-text">安装</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E9%85%8D%E7%BD%AE"><span class="toc-number">1.4.2.3.</span> <span class="toc-text">修改配置</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E5%AE%89%E8%A3%85%E6%BA%90"><span class="toc-number">1.5.</span> <span class="toc-text">配置安装源</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E9%95%9C%E5%83%8F"><span class="toc-number">1.5.1.</span> <span class="toc-text">修改镜像</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E5%88%9D%E5%A7%8B%E5%8C%96%E9%85%8D%E7%BD%AE"><span class="toc-number">1.5.2.</span> <span class="toc-text">修改初始化配置</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-number">1.6.</span> <span class="toc-text">初始化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE-Calico"><span class="toc-number">1.7.</span> <span class="toc-text">配置 Calico</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE-Metrics-Server"><span class="toc-number">1.8.</span> <span class="toc-text">配置 Metrics-Server</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E5%91%BD%E4%BB%A4%E8%A1%8C%E8%87%AA%E5%8A%A8%E8%A1%A5%E5%85%A8%E5%8A%9F%E8%83%BD"><span class="toc-number">1.9.</span> <span class="toc-text">配置命令行自动补全功能</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#HELM"><span class="toc-number">2.</span> <span class="toc-text">HELM</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%8B%E7%BB%8D-1"><span class="toc-number">2.1.</span> <span class="toc-text">介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E8%A3%85HELM"><span class="toc-number">2.2.</span> <span class="toc-text">安装HELM</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%93%8D%E4%BD%9CHELM"><span class="toc-number">2.3.</span> <span class="toc-text">操作HELM</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9F%A5%E6%89%BE-charts"><span class="toc-number">2.3.1.</span> <span class="toc-text">查找 charts</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E5%89%8D%E8%87%AA%E5%AE%9A%E4%B9%89-chart"><span class="toc-number">2.3.2.</span> <span class="toc-text">安装前自定义 chart</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%BD%E8%B8%AA-release-%E7%9A%84%E7%8A%B6%E6%80%81"><span class="toc-number">2.3.3.</span> <span class="toc-text">追踪 release 的状态</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9B%B4%E5%A4%9A%E5%AE%89%E8%A3%85%E6%96%B9%E6%B3%95"><span class="toc-number">2.3.4.</span> <span class="toc-text">更多安装方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8D%87%E7%BA%A7-release"><span class="toc-number">2.3.5.</span> <span class="toc-text">升级 release</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%B1%E8%B4%A5%E6%97%B6%E6%81%A2%E5%A4%8D"><span class="toc-number">2.3.6.</span> <span class="toc-text">失败时恢复</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8D%B8%E8%BD%BD-release"><span class="toc-number">2.3.7.</span> <span class="toc-text">卸载 release</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E4%BB%93%E5%BA%93"><span class="toc-number">2.3.8.</span> <span class="toc-text">使用仓库</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/Jeff'sPlaylist/" title="Jeff's Playlist"><img src="https://ff09945.webp.li/MorishimaHaruka_3.png" onerror="this.onerror=null;this.src='https://ff09945.webp.li/MorishimaHaruka_2.png'" alt="Jeff's Playlist"/></a><div class="content"><a class="title" href="/Jeff'sPlaylist/" title="Jeff's Playlist">Jeff's Playlist</a><time datetime="2025-01-11T07:30:00.000Z" title="发表于 2025-01-11 15:30:00">2025-01-11</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/CentosCompliesHadoop/" title="Centos7.9 编译 Hadoop3.4.0"><img src="https://ff09945.webp.li/MorishimaHaruka_3.png" onerror="this.onerror=null;this.src='https://ff09945.webp.li/MorishimaHaruka_2.png'" alt="Centos7.9 编译 Hadoop3.4.0"/></a><div class="content"><a class="title" href="/CentosCompliesHadoop/" title="Centos7.9 编译 Hadoop3.4.0">Centos7.9 编译 Hadoop3.4.0</a><time datetime="2024-07-18T10:33:00.000Z" title="发表于 2024-07-18 18:33:00">2024-07-18</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/LinearRegression/" title="Linear Regression"><img src="https://ff09945.webp.li/MorishimaHaruka_3.png" onerror="this.onerror=null;this.src='https://ff09945.webp.li/MorishimaHaruka_2.png'" alt="Linear Regression"/></a><div class="content"><a class="title" href="/LinearRegression/" title="Linear Regression">Linear Regression</a><time datetime="2023-12-10T16:00:02.000Z" title="发表于 2023-12-11 00:00:02">2023-12-11</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/JupyterNotebookInstallation/" title="Jupyter Notebook 安装"><img src="https://ff09945.webp.li/MorishimaHaruka_3.png" onerror="this.onerror=null;this.src='https://ff09945.webp.li/MorishimaHaruka_2.png'" alt="Jupyter Notebook 安装"/></a><div class="content"><a class="title" href="/JupyterNotebookInstallation/" title="Jupyter Notebook 安装">Jupyter Notebook 安装</a><time datetime="2023-12-10T16:00:01.000Z" title="发表于 2023-12-11 00:00:01">2023-12-11</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/Kubernetes/" title="Kubernetes 安装"><img src="https://ff09945.webp.li/MorishimaHaruka_3.png" onerror="this.onerror=null;this.src='https://ff09945.webp.li/MorishimaHaruka_2.png'" alt="Kubernetes 安装"/></a><div class="content"><a class="title" href="/Kubernetes/" title="Kubernetes 安装">Kubernetes 安装</a><time datetime="2023-11-10T16:00:00.000Z" title="发表于 2023-11-11 00:00:00">2023-11-11</time></div></div></div></div></div></div></main><footer id="footer" style="background: transparent;"><div id="footer-wrap"><!-- display waves--><section class="main-hero-waves-area waves-area"></section><svg class="waves-svg1" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 0 150 40" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M 0 30 Q 25 15, 50 30 T 100 30 T 150 30 V 50 H 0 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="前往评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/medium-zoom/dist/medium-zoom.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><div class="js-pjax"><script>(async () => {
  const showKatex = () => {
    document.querySelectorAll('#article-container .katex').forEach(el => el.classList.add('katex-show'))
  }

  if (!window.katex_js_css) {
    window.katex_js_css = true
    await btf.getCSS('https://cdn.jsdelivr.net/npm/katex/dist/katex.min.css')
    if (true) {
      await btf.getScript('https://cdn.jsdelivr.net/npm/katex/dist/contrib/copy-tex.min.js')
    }
  }

  showKatex()
})()</script><script>(() => {
  const isShuoshuo = GLOBAL_CONFIG_SITE.pageType === 'shuoshuo'
  const option = null

  const commentCount = n => {
    const isCommentCount = document.querySelector('#post-meta .gitalk-comment-count')
    if (isCommentCount) {
      isCommentCount.textContent= n
    }
  }

  const initGitalk = (el, path) => {
    if (isShuoshuo) {
      window.shuoshuoComment.destroyGitalk = () => {
        if (el.children.length) {
          el.innerHTML = ''
          el.classList.add('no-comment')
        }
      }
    }

    const gitalk = new Gitalk({
      clientID: 'Ov23liLi5I2iIluEap7Y',
      clientSecret: '51f16c78325c36c02732e0455ab59c8e6537791c',
      repo: 'hentaiacg.github.io',
      owner: 'hentaiacg',
      admin: ['hentaiacg'],
      updateCountCallback: commentCount,
      ...option,
      id: isShuoshuo ? path : (option && option.id) || 'afd289025160f815613a025cb1dcf59c'
    })

    gitalk.render('gitalk-container')
  }

  const loadGitalk = async(el, path) => {
    if (typeof Gitalk === 'function') initGitalk(el, path)
    else {
      await btf.getCSS('https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css')
      await btf.getScript('https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.js')
      initGitalk(el, path)
    }
  }

  if (isShuoshuo) {
    'Gitalk' === 'Gitalk'
      ? window.shuoshuoComment = { loadComment: loadGitalk }
      : window.loadOtherComment = loadGitalk
    return
  }

  if ('Gitalk' === 'Gitalk' || !false) {
    if (false) btf.loadComment(document.getElementById('gitalk-container'), loadGitalk)
    else loadGitalk()
  } else {
    window.loadOtherComment = loadGitalk
  }
})()</script></div><canvas class="fireworks" mobile="false"></canvas><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/fireworks.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = true;
POWERMODE.mobile = false;
document.body.addEventListener('input', POWERMODE);
</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>